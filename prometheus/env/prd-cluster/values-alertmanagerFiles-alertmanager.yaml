## alertmanager ConfigMap entries
##
alertmanagerFiles:
  alertmanager.yml:
    route:
      group_wait: 1s
      group_interval: 5m
      group_by:
        - '...'
      receiver: default-receiver
      repeat_interval: 4h
      routes:
        - receiver: prd-warning
          group_wait: 10s
          continue: true
          matchers:
            - severity="warning"
        - receiver: prd-critical
          group_wait: 10s
          continue: true
          matchers:
            - severity=~"critical"
        - receiver: data-critical
          group_wait: 10s
          continue: true
          matchers:
            - severity=~"critical"
            - team="data"
        - receiver: opsgenie-teamdevops
          group_interval: 1m
          continue: true         
          matchers:
            - severity=~"critical"
          mute_time_intervals:
            - offhours
            - saturday
            - sunday

    time_intervals:
      - name: offhours
        time_intervals:
          - weekdays: ['monday:friday']
            times:
              - start_time: 03:00
                end_time: 10:00
      - name: saturday
        time_intervals:
          - weekdays: ['saturday']
            times:
              - start_time: 03:00
                end_time: 12:00
      - name: sunday
        time_intervals:
          - weekdays: ['sunday']
            times:
              - start_time: 03:00
                end_time: 14:00
      
                
        
    receivers:
      - name: default-receiver
        slack_configs:
          - channel: '#devops-alerts-prd'
            api_url: 'https://hooks.slack.com/services/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'
            send_resolved: true
            icon_url: https://avatars3.githubusercontent.com/u/3380462
            text: >-
              {{ range .Alerts }}
                *Alert:* {{ .Annotations.summary }} - `{{ .Labels.severity }}`
                *Description:* {{ .Annotations.description }}
                *Graph:* <{{ .GeneratorURL }}|:chart_with_upwards_trend:> *Runbook:* <{{ .Annotations.runbook }}|:spiral_note_pad:>
                *Details:*
                {{ range .Labels.SortedPairs }} • *{{ .Name }}:* `{{ .Value }}`
                {{ end }}
              {{ end }}

      - name: prd-warning
        slack_configs:
          - channel: '#tech-devops-alerts-feed-prd'
            api_url: 'https://hooks.slack.com/services/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'
            send_resolved: true
            icon_url: https://avatars3.githubusercontent.com/u/3380462
            text: >-
              {{ range .Alerts }}
                *Alert:* {{ .Annotations.summary }} - `{{ .Labels.severity }}`
                *Description:* {{ .Annotations.description }}
                *Team:* <@{{ .Annotations.team }}>
                  *Graph:* <https://grafana.private.infra-services.mundi.work/d/XlS0CN-mk/pulsar-prd?orgId=1&viewPanel=12|Grafana Dashboard>
                {{ range .Labels.SortedPairs }} • *{{ .Name }}:* `{{ .Value }}`
                {{ end }}
              {{ end }}

      - name: prd-critical
        slack_configs:
          - channel: '#devops-alerts-prd'
            api_url: 'https://hooks.slack.com/services/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'
            send_resolved: true
            icon_url: https://avatars3.githubusercontent.com/u/3380462
            text: >-
              {{ range .Alerts }}
                *Alert:* {{ .Annotations.summary }} - `{{ .Labels.severity }}`
                *Description:* {{ .Annotations.description }}
                *Team:* <@{{ .Annotations.team }}>
                *Graph:* <https://grafana.private.infra-services.mundi.work/d/XlS0CN-mk/pulsar-prd?orgId=1&viewPanel=12|Grafana Dashboard>
                *Details:*
                {{ range .Labels.SortedPairs }} • *{{ .Name }}:* `{{ .Value }}`
                {{ end }}
              {{ end }}

      - name: data-critical
        slack_configs:
          - channel: '#data-airbyte-alerts-prd'
            api_url: 'https://hooks.slack.com/services/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'
            send_resolved: true
            icon_url: https://avatars3.githubusercontent.com/u/3380462
            text: >-
              {{ range .Alerts }}
                *Alert:* {{ .Annotations.summary }} - `{{ .Labels.severity }}`
                *Description:* {{ .Annotations.description }}
                *Team:* <@{{ .Annotations.team }}>
                *Graph:* <https://grafana.private.infra-services.mundi.work/d/XlS0CN-mk/pulsar-prd?orgId=1&viewPanel=12|Grafana Dashboard>
                *Details:*
                {{ range .Labels.SortedPairs }} • *{{ .Name }}:* `{{ .Value }}`
                {{ end }}
              {{ end }}
      
      - name: opsgenie-teamdevops
        opsgenie_configs:
        - send_resolved: true
          http_config: {}
          api_key_file: /etc/secrets/api-key
          message: '{{ template "opsgenie.default.message" . }}'
          description: '{{ template "opsgenie.default.description" . }}'
          source: '{{ template "opsgenie.default.source" . }}'
          responders:
          - name: Devops_escalation
            type: escalation
          priority: 'P1'
          
      # - name: opsgenie-team-tech
      #   opsgenie_configs:
      #   - send_resolved: true
      #     tags: team-tech
      #     http_config: {}
      #     api_key_file: /etc/secrets/tech/api-key-tech
      #     message: '{{ template "opsgenie.default.message" . }}'
      #     description: '{{ template "opsgenie.default.description" . }}'
      #     source: '{{ template "opsgenie.default.source" . }}'
      #     responders:
      #     - name: team-tech_escalation
      #       type: escalation
      #     priority: 'P1'
